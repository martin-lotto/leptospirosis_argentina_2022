---
title: "Explore model outputs"
author: "M Lotto & E Rees"
date: "2022"
output:  
  html_document:
    toc: true
    toc_depth: 4
    toc_float: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=15)
```

```{r}
pacman::p_load("tidyverse", "here", "RColorBrewer", "rmarkdown", "cowplot", "ggpubr", "kableExtra")

# Prepare data
df.lepto <- readRDS(here("data_use", "prov_cases.rds"))
pop <- readRDS(here("data_use", "pop.rds"))

data.lepto <- df.lepto %>% 
  left_join(pop) %>% 
  arrange(prov, year, month)

df.er <- data.lepto %>% filter(prov=="Entre Ríos")
df.sf <- data.lepto %>% filter(prov=="Santa Fe")

# Functions
plot.ts <- function(obs, data, n, ttl){
  data[[n]] %>% 
  bind_cols(cases=obs$cases,
            date=obs$date) %>% 
  ggplot(aes(x=date)) +
  geom_line(aes(y=cases, col="Cases")) +
  geom_line(aes(y=mean, col="Predicted")) +
  geom_ribbon(aes(ymin=`0.025quant`, ymax=`0.975quant`), alpha=0.3) +
  scale_color_manual(name="", 
                     values = c("Cases"="grey20", "Predicted"="blue")) +
  labs(title=ttl, x = "",y="") +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  theme_bw() +
  theme(legend.position="none",
        axis.text.x=element_text(angle=25, hjust=1))
}

plot.effs <- function(data, n, ttl){
  data[[n]] %>%
    filter(!var=="(Intercept)") %>% 
    ggplot() +
    geom_pointrange(aes(x=var, y=mean, ymin=`0.025quant`, ymax=`0.975quant`)) +
    coord_flip() +
    labs(x="", y="", title=ttl) +
    geom_hline(yintercept=0) +
    theme_bw()
}

# Fitted models
er.enso.fit <- readRDS(here("model_out", "er_enso_fit.rds"))
er.clim.fit <- readRDS(here("model_out", "er_clim_fit.rds"))
sf.enso.fit <- readRDS(here("model_out", "sf_enso_fit.rds"))
sf.clim.fit <- readRDS(here("model_out", "sf_clim_fit.rds"))
```

## Entre Ríos {.tabset}
### ENSO Models
#### Heatmaps
```{r}
dt <- er.enso.fit$gof %>%
  mutate(form=ifelse(form=="", "REs", form),
         dic=round(dic),
         across(.cols=c(4:15), ~round(.x, 2))) %>%
  slice(-1) %>% 
  dplyr::select(mod, form, dic, rsq.null, rsq.re, mean.mae, crps, crpss.null, crpss.re)

pt1 <- dt %>%
  arrange(dic) %>% 
  mutate(adeq="DIC") %>% 
  ggplot(aes(x=adeq, y=form)) +
  geom_tile(aes(fill=dic)) +
  geom_text(aes(label=dic)) +
  scale_fill_gradient(low="red", high="white") +
  labs(x="", y="", fill="DIC") +
  theme_minimal() +
  theme(legend.position="none")

pt2 <- dt %>%
  arrange(desc(rsq.null)) %>% 
  mutate(adeq="R2 to null") %>% 
  ggplot(aes(x=adeq, y=form)) +
  geom_tile(aes(fill=rsq.null)) +
  geom_text(aes(label=rsq.null)) +
  scale_fill_gradient(low="white", high="red") +
  labs(x="", y="", fill="R2") +
  theme_minimal() +
  theme(legend.position="none")

pt3 <- dt %>%
  arrange(desc(rsq.re)) %>% 
  mutate(adeq="R2 to REs") %>% 
  ggplot(aes(x=adeq, y=form)) +
  geom_tile(aes(fill=rsq.re)) +
  geom_text(aes(label=rsq.re)) +
  scale_fill_gradient(low="white", high="red") +
  labs(x="", y="", fill="R2 to null") +
  theme_minimal() +
  theme(legend.position="none")

pt4 <- dt %>%
  arrange(mean.mae) %>% 
  mutate(adeq="MAE") %>% 
  ggplot(aes(x=adeq, y=form)) +
  geom_tile(aes(fill=mean.mae)) +
  geom_text(aes(label=mean.mae)) +
  scale_fill_gradient(low="red", high="white") +
  labs(x="", y="", fill="MAE") +
  theme_minimal() +
  theme(legend.position="none")

pt5 <- dt %>%
  arrange(crps) %>% 
  mutate(adeq="CRPS") %>% 
  ggplot(aes(x=adeq, y=form)) +
  geom_tile(aes(fill=crps)) +
  geom_text(aes(label=crps)) +
  scale_fill_gradient(low="red", high="white") +
  labs(x="", y="", fill="CRPS") +
  theme_minimal() +
  theme(legend.position="none")

cowplot::plot_grid(pt1, pt2, pt3, pt4, pt5, nrow=1)
```

#### GoF tables {.tabset}
```{r}
dt <- er.enso.fit$gof %>%
  mutate(form=ifelse(form=="", "REs", form),
         dic=round(dic),
         across(.cols=c(4:15), ~round(.x, 2))) %>%
  slice(-1)
```

##### DIC
```{r echo=FALSE}
dt %>% 
  mutate(dif.base = dic - first(dic)) %>% 
  arrange(dic) %>% 
  mutate(dif = first(dic)-dic) %>% 
  dplyr::select(mod, form, dic, dif, dif.base) %>%
  magrittr::set_colnames(c("mod ID", "Formula", "DIC", "Dif to best", "Dif to ref")) %>% 
  paged_table()
```

##### MAE
```{r echo=FALSE}
dt %>% 
  arrange(mean.mae) %>% 
  dplyr::select(mod, form, mean.mae) %>%
  magrittr::set_colnames(c("mod ID", "Formula", "MAE")) %>% 
  paged_table()
```

##### Dif in MAE to null
```{r echo=FALSE}
dt %>% 
  arrange(mean.dif.mae.null) %>% 
  dplyr::select(mod, form, mean.dif.mae.null) %>%
  magrittr::set_colnames(c("mod ID", "Formula", "Dif in MAE")) %>% 
  paged_table()
```

##### Dif in MAE to REs
```{r echo=FALSE}
dt %>% 
  arrange(mean.dif.mae.re) %>% 
  dplyr::select(mod, form, mean.dif.mae.re) %>%
  magrittr::set_colnames(c("mod ID", "Formula", "Dif in MAE")) %>% 
  paged_table()
```

##### CRPS
```{r echo=FALSE}
dt %>% 
  arrange(crps) %>% 
  dplyr::select(mod, form, crps) %>%
  magrittr::set_colnames(c("mod ID", "Formula", "CRPS")) %>% 
  paged_table()
```

#### Times series
```{r fig.height=12}
pt1 <- plot.ts(df.er, er.enso.fit$fits, 3, "Lag 0")
pt2 <- plot.ts(df.er, er.enso.fit$fits, 4, "Lag 1")
pt3 <- plot.ts(df.er, er.enso.fit$fits, 5, "Lag 2")
pt4 <- plot.ts(df.er, er.enso.fit$fits, 6, "Lag 3")
pt5 <- plot.ts(df.er, er.enso.fit$fits, 7, "Lag 4")
pt6 <- plot.ts(df.er, er.enso.fit$fits, 8, "Lag 5")
pt7 <- plot.ts(df.er, er.enso.fit$fits, 9, "Lag 6")
pt8 <- plot.ts(df.er, er.enso.fit$fits, 10, "Lag 7")
pt9 <- plot.ts(df.er, er.enso.fit$fits, 11, "Lag 8")
pt10 <- plot.ts(df.er, er.enso.fit$fits, 12, "Lag 9")
pt11 <- plot.ts(df.er, er.enso.fit$fits, 13, "Lag 10")
pt12 <- plot.ts(df.er, er.enso.fit$fits, 14, "Lag 11")
pt13 <- plot.ts(df.er, er.enso.fit$fits, 15, "Lag 12")

leg <- cowplot::get_legend(pt7+theme(legend.position="right"))

cowplot::plot_grid(pt1, pt2, pt3, pt4, pt5, pt6, pt7, 
                   pt8, pt9, pt10, pt11, pt12, pt13, leg, ncol=3)
```

#### Effect sizes
```{r fig.height=10}
er.enso.fit$params %>%
  bind_rows() %>% 
  filter(!var=="(Intercept)") %>%
  mutate(var=factor(str_replace(var, "nino34\\.", "Lag "), levels=paste0("Lag ", c(0:12)))) %>% 
  ggplot() +
  geom_pointrange(aes(x=var, y=mean, ymin=`0.025quant`, ymax=`0.975quant`)) +
  coord_flip() +
  labs(x="", y="", title="ENSO") +
  geom_hline(yintercept=0) +
  theme_bw()
```

### Local Models
#### Heatmaps
```{r}
dt <- er.clim.fit$gof %>%
  mutate(form=ifelse(form=="", "REs", form),
         dic=round(dic),
         across(.cols=c(4:15), ~round(.x, 2))) %>%
  filter(!grepl("nino", form),
         !grepl("0", form)) %>% 
  slice(-1) %>% 
  dplyr::select(mod, form, dic, rsq.null, rsq.re, mean.mae, crps, crpss.null, crpss.re)

pt1 <- dt %>%
  arrange(dic) %>% 
  slice(1:10) %>% 
  mutate(adeq="DIC") %>% 
  ggplot(aes(x=adeq, y=form)) +
  geom_tile(aes(fill=dic)) +
  geom_text(aes(label=dic)) +
  scale_fill_gradient(low="red", high="white") +
  labs(x="", y="", fill="DIC") +
  theme_minimal() +
  theme(legend.position="none")

pt2 <- dt %>%
  arrange(desc(rsq.null)) %>% 
  slice(1:10) %>% 
  mutate(adeq="R2 to null") %>% 
  ggplot(aes(x=adeq, y=form)) +
  geom_tile(aes(fill=rsq.null)) +
  geom_text(aes(label=rsq.null)) +
  scale_fill_gradient(low="white", high="red") +
  labs(x="", y="", fill="R2") +
  theme_minimal() +
  theme(legend.position="none")

pt3 <- dt %>%
  arrange(desc(rsq.re)) %>% 
  slice(1:10) %>% 
  mutate(adeq="R2 to REs") %>% 
  ggplot(aes(x=adeq, y=form)) +
  geom_tile(aes(fill=rsq.re)) +
  geom_text(aes(label=rsq.re)) +
  scale_fill_gradient(low="white", high="red") +
  labs(x="", y="", fill="R2 to null") +
  theme_minimal() +
  theme(legend.position="none")

pt4 <- dt %>%
  arrange(mean.mae) %>% 
  slice(1:10) %>% 
  mutate(adeq="MAE") %>% 
  ggplot(aes(x=adeq, y=form)) +
  geom_tile(aes(fill=mean.mae)) +
  geom_text(aes(label=mean.mae)) +
  scale_fill_gradient(low="red", high="white") +
  labs(x="", y="", fill="MAE") +
  theme_minimal() +
  theme(legend.position="none")

pt5 <- dt %>%
  arrange(crps) %>% 
  slice(1:10) %>% 
  mutate(adeq="CRPS") %>% 
  ggplot(aes(x=adeq, y=form)) +
  geom_tile(aes(fill=crps)) +
  geom_text(aes(label=crps)) +
  scale_fill_gradient(low="red", high="white") +
  labs(x="", y="", fill="CRPS") +
  theme_minimal() +
  theme(legend.position="none")

cowplot::plot_grid(pt1, pt2, pt3, pt4, pt5, nrow=1)
```

#### GoF tables {.tabset}
```{r}
dt <- er.clim.fit$gof %>%
  mutate(form=ifelse(form=="", "REs", form),
         dic=round(dic),
         across(.cols=c(4:15), ~round(.x, 2))) %>%
  filter(!grepl("nino", form),
         !grepl("0", form)) %>% 
  slice(-1)
```

##### DIC
```{r echo=FALSE}
dt %>% 
  mutate(dif.base = dic - first(dic)) %>% 
  arrange(dic) %>% 
  mutate(dif = first(dic)-dic) %>% 
  dplyr::select(mod, form, dic, dif, dif.base) %>%
  magrittr::set_colnames(c("mod ID", "Formula", "DIC", "Dif to best", "Dif to ref")) %>% 
  paged_table()
```

##### MAE
```{r echo=FALSE}
dt %>% 
  arrange(mean.mae) %>% 
  dplyr::select(mod, form, mean.mae) %>%
  magrittr::set_colnames(c("mod ID", "Formula", "MAE")) %>% 
  paged_table()
```

##### Dif in MAE to null
```{r echo=FALSE}
dt %>% 
  arrange(mean.dif.mae.null) %>% 
  dplyr::select(mod, form, mean.dif.mae.null) %>%
  magrittr::set_colnames(c("mod ID", "Formula", "Dif in MAE")) %>% 
  paged_table()
```

##### Dif in MAE to REs
```{r echo=FALSE}
dt %>% 
  arrange(mean.dif.mae.re) %>% 
  dplyr::select(mod, form, mean.dif.mae.re) %>%
  magrittr::set_colnames(c("mod ID", "Formula", "Dif in MAE")) %>% 
  paged_table()
```

##### CRPS
```{r echo=FALSE}
dt %>% 
  arrange(crps) %>% 
  dplyr::select(mod, form, crps) %>%
  magrittr::set_colnames(c("mod ID", "Formula", "CRPS")) %>% 
  paged_table()
```

#### Times series
```{r fig.height=12}
pt1 <- plot.ts(df.er, er.clim.fit$fits, 4, "Par1")
pt2 <- plot.ts(df.er, er.clim.fit$fits, 18, "Par1+Prcp1")
pt3 <- plot.ts(df.er, er.clim.fit$fits, 19, "Par2+Prcp1")
pt4 <- plot.ts(df.er, er.clim.fit$fits, 20, "Par3+Prcp1")
pt5 <- plot.ts(df.er, er.clim.fit$fits, 25, "Par1+Prcp2")
pt6 <- plot.ts(df.er, er.clim.fit$fits, 32, "Par1+Prcp3")
pt7 <- plot.ts(df.er, er.clim.fit$fits, 39, "Par1+Prcp4")
pt8 <- plot.ts(df.er, er.clim.fit$fits, 46, "Par1+prcp5")
pt9 <- plot.ts(df.er, er.clim.fit$fits, 5, "Par2")
pt10 <- plot.ts(df.er, er.clim.fit$fits, 6, "Par3")

leg <- cowplot::get_legend(pt7+theme(legend.position="right"))

cowplot::plot_grid(pt1, pt2, pt3, pt4, pt5, 
                   pt6, pt7, pt8, pt9, pt10, leg, ncol=3)
```

#### Effect sizes
```{r fig.height=10}
pt1 <- plot.effs(er.clim.fit$params, 4, "Par1")
pt2 <- plot.effs(er.clim.fit$params, 18, "Par1+Prcp1")
pt3 <- plot.effs(er.clim.fit$params, 19, "Par2+Prcp1")
pt4 <- plot.effs(er.clim.fit$params, 20, "Par3+Prcp1")
pt5 <- plot.effs(er.clim.fit$params, 25, "Par1+Prcp2")
pt6 <- plot.effs(er.clim.fit$params, 32, "Par1+Prcp3")
pt7 <- plot.effs(er.clim.fit$params, 39, "Par1+Prcp4")
pt8 <- plot.effs(er.clim.fit$params, 46, "Par1+prcp5")
pt9 <- plot.effs(er.clim.fit$params, 5, "Par2")
pt10 <- plot.effs(er.clim.fit$params, 6, "Par3")

cowplot::plot_grid(pt1, pt2, pt3, pt4, pt5, 
                   pt6, pt7, pt8, pt9, pt10, ncol=3)
```

## Santa Fe {.tabset}
### ENSO Models
#### Heatmaps
```{r}
dt <- sf.enso.fit$gof %>%
  mutate(form=ifelse(form=="", "REs", form),
         dic=round(dic),
         across(.cols=c(4:15), ~round(.x, 2))) %>%
  slice(-1) %>% 
  dplyr::select(mod, form, dic, rsq.null, rsq.re, mean.mae, crps, crpss.null, crpss.re)

pt1 <- dt %>%
  arrange(dic) %>% 
  mutate(adeq="DIC") %>% 
  ggplot(aes(x=adeq, y=form)) +
  geom_tile(aes(fill=dic)) +
  geom_text(aes(label=dic)) +
  scale_fill_gradient(low="red", high="white") +
  labs(x="", y="", fill="DIC") +
  theme_minimal() +
  theme(legend.position="none")

pt2 <- dt %>%
  arrange(desc(rsq.null)) %>% 
  mutate(adeq="R2 to null") %>% 
  ggplot(aes(x=adeq, y=form)) +
  geom_tile(aes(fill=rsq.null)) +
  geom_text(aes(label=rsq.null)) +
  scale_fill_gradient(low="white", high="red") +
  labs(x="", y="", fill="R2") +
  theme_minimal() +
  theme(legend.position="none")

pt3 <- dt %>%
  arrange(desc(rsq.re)) %>% 
  mutate(adeq="R2 to REs") %>% 
  ggplot(aes(x=adeq, y=form)) +
  geom_tile(aes(fill=rsq.re)) +
  geom_text(aes(label=rsq.re)) +
  scale_fill_gradient(low="white", high="red") +
  labs(x="", y="", fill="R2 to null") +
  theme_minimal() +
  theme(legend.position="none")

pt4 <- dt %>%
  arrange(mean.mae) %>% 
  mutate(adeq="MAE") %>% 
  ggplot(aes(x=adeq, y=form)) +
  geom_tile(aes(fill=mean.mae)) +
  geom_text(aes(label=mean.mae)) +
  scale_fill_gradient(low="red", high="white") +
  labs(x="", y="", fill="MAE") +
  theme_minimal() +
  theme(legend.position="none")

pt5 <- dt %>%
  arrange(crps) %>% 
  mutate(adeq="CRPS") %>% 
  ggplot(aes(x=adeq, y=form)) +
  geom_tile(aes(fill=crps)) +
  geom_text(aes(label=crps)) +
  scale_fill_gradient(low="red", high="white") +
  labs(x="", y="", fill="CRPS") +
  theme_minimal() +
  theme(legend.position="none")

cowplot::plot_grid(pt1, pt2, pt3, pt4, pt5, nrow=1)
```

#### GoF tables {.tabset}
```{r}
dt <- sf.enso.fit$gof %>%
  mutate(form=ifelse(form=="", "REs", form),
         dic=round(dic),
         across(.cols=c(4:15), ~round(.x, 2))) %>%
  slice(-1)
```

##### DIC
```{r echo=FALSE}
dt %>% 
  mutate(dif.base = dic - first(dic)) %>% 
  arrange(dic) %>% 
  mutate(dif = first(dic)-dic) %>% 
  dplyr::select(mod, form, dic, dif, dif.base) %>%
  magrittr::set_colnames(c("mod ID", "Formula", "DIC", "Dif to best", "Dif to ref")) %>% 
  paged_table()
```

##### MAE
```{r echo=FALSE}
dt %>% 
  arrange(mean.mae) %>% 
  dplyr::select(mod, form, mean.mae) %>%
  magrittr::set_colnames(c("mod ID", "Formula", "MAE")) %>% 
  paged_table()
```

##### Dif in MAE to null
```{r echo=FALSE}
dt %>% 
  arrange(mean.dif.mae.null) %>% 
  dplyr::select(mod, form, mean.dif.mae.null) %>%
  magrittr::set_colnames(c("mod ID", "Formula", "Dif in MAE")) %>% 
  paged_table()
```

##### Dif in MAE to REs
```{r echo=FALSE}
dt %>% 
  arrange(mean.dif.mae.re) %>% 
  dplyr::select(mod, form, mean.dif.mae.re) %>%
  magrittr::set_colnames(c("mod ID", "Formula", "Dif in MAE")) %>% 
  paged_table()
```

##### CRPS
```{r echo=FALSE}
dt %>% 
  arrange(crps) %>% 
  dplyr::select(mod, form, crps) %>%
  magrittr::set_colnames(c("mod ID", "Formula", "CRPS")) %>% 
  paged_table()
```

#### Times series
```{r fig.height=12}
pt1 <- plot.ts(df.sf, sf.enso.fit$fits, 3, "Lag 0")
pt2 <- plot.ts(df.sf, sf.enso.fit$fits, 4, "Lag 1")
pt3 <- plot.ts(df.sf, sf.enso.fit$fits, 5, "Lag 2")
pt4 <- plot.ts(df.sf, sf.enso.fit$fits, 6, "Lag 3")
pt5 <- plot.ts(df.sf, sf.enso.fit$fits, 7, "Lag 4")
pt6 <- plot.ts(df.sf, sf.enso.fit$fits, 8, "Lag 5")
pt7 <- plot.ts(df.sf, sf.enso.fit$fits, 9, "Lag 6")
pt8 <- plot.ts(df.sf, sf.enso.fit$fits, 10, "Lag 7")
pt9 <- plot.ts(df.sf, sf.enso.fit$fits, 11, "Lag 8")
pt10 <- plot.ts(df.sf, sf.enso.fit$fits, 12, "Lag 9")
pt11 <- plot.ts(df.sf, sf.enso.fit$fits, 13, "Lag 10")
pt12 <- plot.ts(df.sf, sf.enso.fit$fits, 14, "Lag 11")
pt13 <- plot.ts(df.sf, sf.enso.fit$fits, 15, "Lag 12")

leg <- cowplot::get_legend(pt7+theme(legend.position="right"))

cowplot::plot_grid(pt1, pt2, pt3, pt4, pt5, pt6, pt7, 
                   pt8, pt9, pt10, pt11, pt12, pt13, leg, ncol=3)
```

#### Effect sizes
```{r fig.height=10}
sf.enso.fit$params %>%
  bind_rows() %>% 
  filter(!var=="(Intercept)") %>%
  mutate(var=factor(str_replace(var, "nino34\\.", "Lag "), levels=paste0("Lag ", c(0:12)))) %>% 
  ggplot() +
  geom_pointrange(aes(x=var, y=mean, ymin=`0.025quant`, ymax=`0.975quant`)) +
  coord_flip() +
  labs(x="", y="", title="ENSO") +
  geom_hline(yintercept=0) +
  theme_bw()
```

### Local Models
#### Heatmaps
```{r}
dt <- sf.clim.fit$gof %>%
  mutate(form=ifelse(form=="", "REs", form),
         dic=round(dic),
         across(.cols=c(4:15), ~round(.x, 2))) %>%
  filter(!grepl("nino", form),
         !grepl("0", form)) %>% 
  slice(-1) %>% 
  dplyr::select(mod, form, dic, rsq.null, rsq.re, mean.mae, crps, crpss.null, crpss.re)

pt1 <- dt %>%
  arrange(dic) %>% 
  slice(1:10) %>% 
  mutate(adeq="DIC") %>% 
  ggplot(aes(x=adeq, y=form)) +
  geom_tile(aes(fill=dic)) +
  geom_text(aes(label=dic)) +
  scale_fill_gradient(low="red", high="white") +
  labs(x="", y="", fill="DIC") +
  theme_minimal() +
  theme(legend.position="none")

pt2 <- dt %>%
  arrange(desc(rsq.null)) %>% 
  slice(1:10) %>% 
  mutate(adeq="R2 to null") %>% 
  ggplot(aes(x=adeq, y=form)) +
  geom_tile(aes(fill=rsq.null)) +
  geom_text(aes(label=rsq.null)) +
  scale_fill_gradient(low="white", high="red") +
  labs(x="", y="", fill="R2") +
  theme_minimal() +
  theme(legend.position="none")

pt3 <- dt %>%
  arrange(desc(rsq.re)) %>% 
  slice(1:10) %>% 
  mutate(adeq="R2 to REs") %>% 
  ggplot(aes(x=adeq, y=form)) +
  geom_tile(aes(fill=rsq.re)) +
  geom_text(aes(label=rsq.re)) +
  scale_fill_gradient(low="white", high="red") +
  labs(x="", y="", fill="R2 to null") +
  theme_minimal() +
  theme(legend.position="none")

pt4 <- dt %>%
  arrange(mean.mae) %>% 
  slice(1:10) %>% 
  mutate(adeq="MAE") %>% 
  ggplot(aes(x=adeq, y=form)) +
  geom_tile(aes(fill=mean.mae)) +
  geom_text(aes(label=mean.mae)) +
  scale_fill_gradient(low="red", high="white") +
  labs(x="", y="", fill="MAE") +
  theme_minimal() +
  theme(legend.position="none")

pt5 <- dt %>%
  arrange(crps) %>% 
  slice(1:10) %>% 
  mutate(adeq="CRPS") %>% 
  ggplot(aes(x=adeq, y=form)) +
  geom_tile(aes(fill=crps)) +
  geom_text(aes(label=crps)) +
  scale_fill_gradient(low="red", high="white") +
  labs(x="", y="", fill="CRPS") +
  theme_minimal() +
  theme(legend.position="none")

cowplot::plot_grid(pt1, pt2, pt3, pt4, pt5, nrow=1)
```

#### GoF tables {.tabset}
```{r}
dt <- sf.clim.fit$gof %>%
  mutate(form=ifelse(form=="", "REs", form),
         dic=round(dic),
         across(.cols=c(4:15), ~round(.x, 2))) %>%
  filter(!grepl("nino", form),
         !grepl("0", form)) %>% 
  slice(-1)
```

##### DIC
```{r echo=FALSE}
dt %>% 
  mutate(dif.base = dic - first(dic)) %>% 
  arrange(dic) %>% 
  mutate(dif = first(dic)-dic) %>% 
  dplyr::select(mod, form, dic, dif, dif.base) %>%
  magrittr::set_colnames(c("mod ID", "Formula", "DIC", "Dif to best", "Dif to ref")) %>% 
  paged_table()
```

##### MAE
```{r echo=FALSE}
dt %>% 
  arrange(mean.mae) %>% 
  dplyr::select(mod, form, mean.mae) %>%
  magrittr::set_colnames(c("mod ID", "Formula", "MAE")) %>% 
  paged_table()
```

##### Dif in MAE to null
```{r echo=FALSE}
dt %>% 
  arrange(mean.dif.mae.null) %>% 
  dplyr::select(mod, form, mean.dif.mae.null) %>%
  magrittr::set_colnames(c("mod ID", "Formula", "Dif in MAE")) %>% 
  paged_table()
```

##### Dif in MAE to REs
```{r echo=FALSE}
dt %>% 
  arrange(mean.dif.mae.re) %>% 
  dplyr::select(mod, form, mean.dif.mae.re) %>%
  magrittr::set_colnames(c("mod ID", "Formula", "Dif in MAE")) %>% 
  paged_table()
```

##### CRPS
```{r echo=FALSE}
dt %>% 
  arrange(crps) %>% 
  dplyr::select(mod, form, crps) %>%
  magrittr::set_colnames(c("mod ID", "Formula", "CRPS")) %>% 
  paged_table()
```

#### Times series
```{r fig.height=12}
pt1 <- plot.ts(df.sf, sf.clim.fit$fits, 25, "Par1+Prcp2")
pt2 <- plot.ts(df.sf, sf.clim.fit$fits, 18, "Par1+Prcp1")
pt3 <- plot.ts(df.sf, sf.clim.fit$fits, 4, "Par1")
pt4 <- plot.ts(df.sf, sf.clim.fit$fits, 19, "Par2+Prcp1")
pt5 <- plot.ts(df.sf, sf.clim.fit$fits, 32, "Par1+Prcp3")
pt6 <- plot.ts(df.sf, sf.clim.fit$fits, 16, "Prcp1")
pt7 <- plot.ts(df.sf, sf.clim.fit$fits, 26, "Par2+Prcp2")
pt8 <- plot.ts(df.sf, sf.clim.fit$fits, 39, "Par1+Prcp4")
pt9 <- plot.ts(df.sf, sf.clim.fit$fits, 46, "Par1+Prcp5")
pt10 <- plot.ts(df.sf, sf.clim.fit$fits, 21, "Par4+Prcp1")

leg <- cowplot::get_legend(pt7+theme(legend.position="right"))

cowplot::plot_grid(pt1, pt2, pt3, pt4, pt5, 
                   pt6, pt7, pt8, pt9, pt10, leg, ncol=3)
```

#### Effect sizes
```{r fig.height=10}
pt1 <- plot.effs(sf.clim.fit$params, 25, "Par1+Prcp2")
pt2 <- plot.effs(sf.clim.fit$params, 18, "Par1+Prcp1")
pt3 <- plot.effs(sf.clim.fit$params, 4, "Par1")
pt4 <- plot.effs(sf.clim.fit$params, 19, "Par2+Prcp1")
pt5 <- plot.effs(sf.clim.fit$params, 32, "Par1+Prcp3")
pt6 <- plot.effs(sf.clim.fit$params, 16, "Prcp1")
pt7 <- plot.effs(sf.clim.fit$params, 26, "Par2+Prcp2")
pt8 <- plot.effs(sf.clim.fit$params, 39, "Par1+Prcp4")
pt9 <- plot.effs(sf.clim.fit$params, 46, "Par1+Prcp5")
pt10 <- plot.effs(sf.clim.fit$params, 21, "Par4+Prcp1")

cowplot::plot_grid(pt1, pt2, pt3, pt4, pt5, 
                   pt6, pt7, pt8, pt9, pt10, ncol=3)
```
